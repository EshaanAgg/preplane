<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preplane | Profile</title>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinycolor2@1.6.0/cjs/tinycolor.min.js"></script>
  <link href="css/style.css" rel="stylesheet" />
</head>

<body class="m-0 font-sans text-base antialiased font-normal leading-default bg-gray-50 text-slate-500">
  <div th:replace="fragments/sidenav :: sidenav">This content will be replaced by the `sidenav` fragment</div>
  <main class="ease-soft-in-out xl:ml-68.5 relative h-full max-h-screen rounded-xl transition-all duration-200">
    <div th:replace="fragments/navbar :: navbar" th:with="name=${title}">This content will be replaced by the `navbar`
      fragment</div>

    <div class="flex flex-wrap mt-6 px-2 ml-4">
      <div class="w-full px-3 mb-6 lg:mb-0 lg:w-7/12 lg:flex-none ml-2" style="width:60%;">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-wrap">
              <div class="max-w-full px-4 lg:w-1/2 lg:flex-none">
                <div class="flex flex-col h-full">
                  <p class="pt-2 mb-1 font-semibold" id="username"></p>
                  <h5 class="font-bold" id="name"></h5> </br>

                  <p class="leading-normal">
                    <svg xmlns="http://www.w3.org/2000/svg" height="1.5em" viewBox="0 0 512 512"
                      style="padding-left: 2px; padding-right: 10px;">
                      <path
                        d="M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64H348.7c2.2 20.4 3.3 41.8 3.3 64zm28.8-64H503.9c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6c78.3 20.7 142 77.5 171.9 151.6zm-149.1 0H167.7c6.1-36.4 15.5-68.6 27-94.7c10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5c11.6 26 20.9 58.2 27 94.7zm-209 0H18.6C48.6 85.9 112.2 29.1 190.6 8.4C165.1 42.6 145.3 96.1 135.3 160zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zM194.7 446.6c-11.6-26-20.9-58.2-27-94.6H344.3c-6.1 36.4-15.5 68.6-27 94.6c-10.5 23.6-22.2 40.7-33.5 51.5C272.6 508.8 263.3 512 256 512s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6C112.2 482.9 48.6 426.1 18.6 352H135.3zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6c25.5-34.2 45.2-87.7 55.3-151.6H493.4z" />
                    </svg>
                    <span class="font-semibold" id="lastActive"></span>
                  </p>
                  <p class="leading-normal">
                    <svg xmlns="http://www.w3.org/2000/svg" height="1.5em" viewBox="0 0 640 512"
                      style="padding-right: 8px;">
                      <path
                        d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM232 344V280H168c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H280v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z" />
                    </svg>
                    <span class="font-semibold" id="problemsSolved"></span>
                  </p>
                  <p class="leading-normal">
                    <svg xmlns="http://www.w3.org/2000/svg" height="1.5em" viewBox="0 0 640 512"
                      style="padding-left: 4px; padding-right: 10px;">
                      <path
                        d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3L562.7 256l-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z" />
                    </svg>
                    <span class="font-semibold" id="problemsAttempted"></span>
                  </p>
                  <p class="leading-normal">
                    <svg xmlns="http://www.w3.org/2000/svg" height="1.6em" viewBox="0 0 384 512"
                      style="padding-left: 6px; padding-right: 10px;">
                      <path
                        d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM112 256H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16z" />
                    </svg>
                    <span class="font-semibold" id="blogsAdded"></span>
                  </p>

                </div>
              </div>
              <div class="max-w-full px-3 mt-12 ml-auto text-center lg:mt-0 lg:w-5/12 lg:flex-none">
                <div class="h-full bg-gradient-to-tl rounded-xl">
                  <div class="relative flex items-center justify-center h-full">
                    <div id="imageContainer"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="w-full max-w-full px-12 lg:w-4/12 pl-4 ml-6">
        <div
          class="border-black/12.5 shadow-soft-xl relative flex h-full min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border p-4">
          <div class="relative h-full overflow-hidden bg-cover rounded-xl">
            <span class="absolute top-0 left-0 w-full h-full bg-center bg-cover bg-gradient-to-tl"></span>
            <div class="relative z-10 flex flex-col flex-auto h-full p-4">
              <h5 class="mb-6 font-bold text-black text-center" id="problems"></h5>
              <div class="flex lg:w-7/12">
                <canvas style="transform: translate(35%, 2%);" id="myChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-wrap mt-6 ml-6 mr-6">
      <div class="w-full px-3 mb-6 lg:mb-0 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
          <div class="flex-auto p-4">
            <div class="flex flex-wrap">
              <div class="max-w-full px-4 lg:flex-none">
                <div class="flex flex-col h-full">
                  <h5 class="ml-2 pt-2 mb-6 text-black" id="submissions"></h5>
                  <div class="graph">
                    <ul class="months" id="months">
                    </ul>
                    <ul class="days">
                      <li>Sun</li>
                      <li>Mon</li>
                      <li>Tue</li>
                      <li>Wed</li>
                      <li>Thu</li>
                      <li>Fri</li>
                      <li>Sat</li>
                    </ul>
                    <ul class="squares">
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-wrap mt-6 mr-6">
        <div class="w-full px-3 mb-6 lg:mb-0  lg:flex-none">
          <div class="relative flex flex-col min-w-0 break-words bg-white shadow-soft-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-4">
              <div class="flex flex-wrap">
                <div class="max-w-full px-4 lg:flex-none">
                  <div class="flex flex-col h-full">
                    <h5 class="ml-2 pt-2 mb-6 text-black">Tags solved</h5>
                    <div>
                      <canvas style="width: 1100px" id="tagsChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
          // Generates `length` number of uniformly distributed colours
          function generateBackgroundColors(length) {
            const colors = [];
            const saturation = 90;
            const lightness = 50;

            for (let i = 0; i < length; i++) {
              const hue = (i * 360) / length;
              const color = tinycolor({h: hue, s: saturation, l: lightness}).toHexString();
              colors.push(color);
            }

            return colors;
          }

          // Utility function to get the date in a human readable format
          function timeAgo(date) {
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 1) {
              return days + " days ago";
            } else if (days === 1) {
              return "1 day ago";
            } else if (hours > 1) {
              return hours + " hours ago";
            } else if (hours === 1) {
              return "1 hour ago";
            } else if (minutes > 1) {
              return minutes + " minutes ago";
            } else if (minutes === 1) {
              return "1 minute ago";
            } else {
              return "just now";
            }
          }

          async function fetchData() {
            const authToken = localStorage.getItem("preplane-authHeader");

            const response = await fetch('/api/users/me', {
              method: 'GET',
              headers: {
                "Authorization": authToken,
                'Content-Type': 'application/json'
              },
            });

            userData = await response.json();

            // Populate the general data
            user = userData;

            // Calculate the problem data that the user interacted with
            let allProblems = new Set()
            let correctProblems = new Set()

            userData.submissions.forEach((submission) => {
              if (submission.compilerVerdict === "AC") correctProblems.add(submission.problem)
              allProblems.add(submission.problem)
            })

            let allProblesArr = Array.from(allProblems)
            let correctProblemArr = Array.from(correctProblems)

            user.problemsSolved = correctProblemArr.length;
            user.problemsAttempted = allProblesArr.length;

            // Group the problems solved by difficulty
            user.easy = correctProblemArr.filter((problem) => problem.tags === null || problem.tags.some((tag) => tag.type === "DIFFICULTY" && tag.name == "Easy")).length;
            user.medium = correctProblemArr.filter((problem) => problem.tags.some((tag) => tag.type === "DIFFICULTY" && tag.name == "Medium")).length;
            user.hard = correctProblemArr.filter((problem) => problem.tags.some((tag) => tag.type === "DIFFICULTY" && tag.name == "Hard")).length;

            // Add the additonal data related to the user
            if (user.avatar == null || user.avatar == undefined) user.avatar = "./assets/img/user.png";
            user.blogsAdded = user.thread?.length || 0;
            user.lastActive = timeAgo(new Date(user.lastLoginAt))


            // Render the topic data
            const tagFrequency = {};

            correctProblemArr.forEach((problem) => {
              problem.tags.forEach((tag) => {
                if (tag.type === "TOPIC") tagFrequency[tag.name] = (tagFrequency[tag] || 0) + 1;
              });
            });

            user.topicLabels = Object.keys(tagFrequency);
            user.topicFreq = Object.values(tagFrequency);

            renderAvatar(user);
            renderProfile(user);
            renderPieChart(user);
            renderActivityTracker(user);
            renderTopicTags(user);
          }

          function renderAvatar(user) {
            let imageAlt = "avatar";
            let imageClass = "relative z-20 w-full pt-6";
            let imageElement = document.createElement("img");

            imageElement.src = user.avatar;
            imageElement.alt = imageAlt;
            imageElement.className = imageClass;

            let container = document.getElementById("imageContainer");
            container.appendChild(imageElement);
          }

          function renderProfile(user) {
            document.getElementById("username").textContent = "@" + user.username;
            document.getElementById("name").textContent = user.firstName + " " + user.lastName;
            document.getElementById("lastActive").textContent = "Last active: " + user.lastActive;
            document.getElementById("problemsSolved").textContent = "Problems Solved: " + user.problemsSolved;
            document.getElementById("problemsAttempted").textContent = "Problems Attempted: " + user.problemsAttempted;
            document.getElementById("blogsAdded").textContent = "Blogs added: " + user.blogsAdded;
          }

          function renderPieChart(user) {
            document.getElementById("problems").textContent = "Problems solved: " + user.problemsSolved;

            // Pie chart for easy, medium and hard problems
            let ctx = document.getElementById("myChart").getContext('2d');
            let myChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ["Easy", "Medium", "Hard"],
                datasets: [{
                  backgroundColor: [
                    "#2ecc71",
                    "#FFC72C",
                    "#E52B50"
                  ],
                  data: [user.easy, user.medium, user.hard]
                }],
              },
              options: {
                plugins: {
                  legend: {
                    display: true,
                    position: "bottom",
                  },
                },
              },
            });
          }

          function renderActivityTracker(user) {
            document.getElementById("submissions").textContent = user.problemsSolved + " submissions in the last year";

            const squares = document.querySelector('.squares');
            const today = new Date();
            const oneDay = 24 * 60 * 60 * 1000;

            for (let i = 364; i >= 0; i--) {
              const currentDate = new Date(today - i * oneDay);

              // Count the number of submissions on the current day
              const submissionsOnDay = user.submissions.filter((submission) => {
                const submissionDate = new Date(submission.submissionTime);
                return (
                  submissionDate.getDate() === currentDate.getDate() &&
                  submissionDate.getMonth() === currentDate.getMonth() &&
                  submissionDate.getFullYear() === currentDate.getFullYear()
                );
              });

              const level = submissionsOnDay.length;
              squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"></li>`);
            }

            // Populate the months in the correct order
            const monthsList = document.querySelector('.months');
            const currentMonth = today.getMonth();

            const monthNames = [
              'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];

            monthsList.innerHTML = '';
            for (let i = 0; i < 12; i++)
              monthsList.insertAdjacentHTML('beforeend', `<li>${monthNames[(i + currentMonth + 1) % 12]}</li>`);
          }

          // Bar chart for topic specific solves
          function renderTopicTags(user) {
            const bgColors = generateBackgroundColors(user.topicFreq.length);

            ctx = document.getElementById("tagsChart").getContext('2d');
            myChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: user.topicLabels,
                datasets: [{
                  label: "Tags",
                  backgroundColor: bgColors,
                  data: user.topicFreq,
                }],
              },
              options: {
                plugins: {
                  legend: {
                    display: false,
                  },
                },
              },
            });

          }

          fetchData();

        </script>
  </main>
</body>

</html>